---
import { Image } from "astro:assets";
import { type CollectionEntry, getCollection, render } from "astro:content";
import Layout from "../../layouts/Layout.astro";

export const getStaticPaths = async () => {
	const allBlogPosts = await getCollection("blog");
	// Sort for prev/next navigation
	const sortedPosts = allBlogPosts.sort(
		(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
	);

	return sortedPosts.map((post, i) => {
		return {
			params: { slug: post.id },
			props: {
				post: post,
				// Pass previous/next posts for navigation
				prevPost:
					i + 1 < sortedPosts.length ? sortedPosts[i + 1] : null,
				nextPost: i > 0 ? sortedPosts[i - 1] : null,
			},
		};
	});
};

const { post, prevPost, nextPost } = Astro.props;
const { Content } = await render(post);
---

<Layout pageTitle={post.data.title}>
	<header class="doc-header">
		<div class="meta-row">
			<span class="path">~/blog/{post.id}.md</span>
		</div>

		<h1 class="doc-title">{post.data.title}</h1>

		<div class="file-info">
			<div class="info-item">
				<span class="label">CREATED:</span>
				<span class="val"
					>{post.data.pubDate.toISOString().slice(0, 10)}</span
				>
			</div>
			<div class="info-item">
				<span class="label">TAGS:</span>
				<span class="val tags">
					{post.data.tags?.map((t) => <span>#{t}</span>)}
				</span>
			</div>
		</div>

		<div class="divider"></div>
		{post.data.heroImage && <Image class={"heroImage"} src={post.data.heroImage} alt={post.data.description} />}
	</header>

	<article class="markdown-content">
		<Content />
	</article>

	<footer class="doc-footer">
		<div class="nav-links">
			{
				prevPost ? (
					<a href={`/blog/${prevPost.id}/`} class="nav-btn prev">
						<span class="arrow">&lt;-</span>
						<span class="link-text">
							prev: {prevPost.data.title}
						</span>
					</a>
				) : (
					<span />
				)
			}

			{
				nextPost ? (
					<a href={`/blog/${nextPost.id}/`} class="nav-btn next">
						<span class="link-text">
							next: {nextPost.data.title}
						</span>
						<span class="arrow">-&gt;</span>
					</a>
				) : (
					<span />
				)
			}
		</div>
	</footer>

	<style>
		/* --- HEADER STYLES --- */
		.doc-header {
			margin-bottom: 1rem;
		}

		.meta-row {
			display: flex;
			justify-content: space-between;
			font-size: 0.8rem;
			color: #888;
			margin-bottom: 1.5rem;
		}

		.doc-title {
			font-family: sans-serif;
			font-size: 2.2rem;
			font-weight: 800;
			line-height: 1.2;
			margin: 0 0 1.5rem 0;
			color: #000;
		}

		.file-info {
			display: flex;
			flex-wrap: wrap;
			gap: 1.5rem;
			font-size: 0.8rem;
			color: #555;
		}

		.info-item {
			display: flex;
			gap: 0.5rem;
		}
		.label {
			font-weight: 700;
			color: #000;
		}
		.tags span {
			margin-right: 0.5rem;
			color: #666;
		}

		.divider {
			margin-top: 1.5rem;
			border-bottom: 2px solid #000;
		}

		.heroImage {
			max-width: 100%;
			height: auto;
		}

		/* --- MARKDOWN CONTENT STYLES --- */
		.markdown-content {
			font-family:
				-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
				Helvetica, Arial, sans-serif;
			font-size: 1.05rem;
			line-height: 1.7;
			color: #333;
			overflow-wrap: break-word;
		}

		/* Headings */
		.markdown-content :global(h2) {
			font-family: "Menlo", monospace;
			font-size: 1.5rem;
			margin-top: 3rem;
			margin-bottom: 1rem;
			color: #000;
			font-weight: 700;
			border-bottom: 1px solid #eee;
			padding-bottom: 0.5rem;
		}

		.markdown-content :global(h3) {
			font-family: "Menlo", monospace;
			font-size: 1.2rem;
			margin-top: 2rem;
			margin-bottom: 0.8rem;
			font-weight: 700;
		}

		/* Text Elements */
		.markdown-content :global(p) {
			margin-bottom: 1.5rem;
		}
		.markdown-content :global(ul),
		.markdown-content :global(ol) {
			margin-bottom: 1.5rem;
			padding-left: 1.5rem;
		}
		.markdown-content :global(li) {
			margin-bottom: 0.5rem;
		}

		.markdown-content :global(a) {
			color: #000;
			text-decoration: underline;
			text-underline-offset: 3px;
			font-weight: 500;
		}
		.markdown-content :global(a:hover) {
			background: #eee;
		}

		/* Blockquotes */
		.markdown-content :global(blockquote) {
			border-left: 4px solid #000;
			padding: 0.5rem 0 0.5rem 1.5rem;
			font-style: italic;
			background: #f9f9f9;
			color: #444;
			margin: 2rem 0;
		}

		/* Code Blocks */
		.markdown-content :global(pre) {
			background: #0d1117;
			color: #c9d1d9;
			padding: 1.2rem;
			border-radius: 6px;
			overflow-x: auto;
			font-size: 0.9rem;
			margin: 1.5rem 0;
			border: 1px solid #30363d;
		}

		.markdown-content :global(code) {
			font-family: "Menlo", "Monaco", monospace;
		}
		.markdown-content :global(p code) {
			background: #eef;
			color: #000;
			padding: 0.2rem 0.4rem;
			border-radius: 4px;
			font-size: 0.85em;
			font-weight: bold;
		}

		/* Images */
		.markdown-content :global(img) {
			max-width: 100%;
			height: auto;
			border: 1px solid #000;
			margin: 2rem 0;
			display: block;
		}

		/* --- TABLES (Scrollable Fix) --- */
		.markdown-content :global(table) {
			width: 100%;
			display: block; /* Enables scroll on the table element */
			overflow-x: auto; /* Adds scrollbar if content is too wide */
			border-collapse: collapse;
			margin: 2.5rem 0;
			font-size: 0.9rem;
			/* border: 1px solid #000; */
			white-space: nowrap; /* Forces content to stay on one line (triggering scroll) */
		}

		.markdown-content :global(th),
		.markdown-content :global(td) {
			padding: 0.75rem 1rem;
			border: 1px solid #ccc;
			text-align: left;
		}

		.markdown-content :global(th) {
			background: #f4f4f5;
			font-weight: 700;
			color: #000;
			font-family: "Menlo", monospace;
			border-bottom: 2px solid #000;
		}

		.markdown-content :global(tr:nth-child(even)) {
			background: #fafafa;
		}

		/* --- DEFINITION LISTS --- */
		.markdown-content :global(dl) {
			margin-bottom: 1.5rem;
			border-left: 2px solid #eee; /* Subtle guide line */
			padding-left: 1rem;
		}

		.markdown-content :global(dt) {
			font-weight: 700;
			font-family:
				"Menlo", monospace; /* Tech/Terminal font for the "Term" */
			color: #000;
			margin-top: 1rem;
			font-size: 0.95rem;
		}

		.markdown-content :global(dd) {
			margin-left: 0;
			margin-bottom: 0.5rem;
			color: #555;
			padding-left: 1rem; /* Indent the definition */
		}

		/* --- FOOTER & NAV --- */
		.doc-footer {
			margin-top: 1rem;
		}

		.eof-marker {
			text-align: center;
			font-size: 0.8rem;
			color: #bbb;
			margin-bottom: 2rem;
			letter-spacing: 2px;
		}

		.nav-links {
			display: flex;
			justify-content: space-between;
			gap: 1rem;
			border-top: 1px solid #eee;
			padding-top: 1.5rem;
			margin-bottom: 2rem;
		}

		.nav-btn {
			display: flex;
			flex-direction: column;
			gap: 0.3rem;
			text-decoration: none;
			max-width: 45%;
		}

		.arrow {
			font-size: 1.2rem;
			color: #000;
		}

		.link-text {
			font-size: 0.85rem;
			color: #666;
			line-height: 1.4;
			transition: color 0.2s;
		}

		.nav-btn:hover .link-text {
			color: #000;
			text-decoration: underline;
		}
		.next {
			text-align: right;
			align-items: flex-end;
		}

		.root-link {
			display: flex;
			justify-content: center;
			margin-top: 2rem;
		}

		/* Mobile Tweak */
		@media (max-width: 600px) {
			.doc-title {
				font-size: 1.8rem;
			}
			.file-info {
				gap: 1rem;
			}
			.markdown-content :global(pre) {
				font-size: 0.8rem;
			}
		}
	</style>
</Layout>
